<!doctype html><html><head><meta charset="utf-8"><title>ANI – Desktop</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:10px 0}
  input,textarea,button{padding:8px;border:1px solid #ccc;border-radius:8px}
  button{cursor:pointer}
  label{display:block;font-size:12px;color:#666;margin-bottom:4px}
</style></head><body>
<h1>ANI – Desktop</h1>

<div class="card">
  <h3>Services</h3>
  <div class="row">
    <div><label>n8n Port</label><input id="portN8n" value="5678"></div>
    <div><label>Ollama Port</label><input id="portOllama" value="11434"></div>
    <button id="btnOpenN8n">n8n öffnen</button>
  </div>
</div>

<div class="card">
  <h3>Chat an Workflow (n8n Webhook)</h3>
  <div class="row">
    <label>Text</label>
    <textarea id="chatText" rows="4" style="width:100%" placeholder="Frage oder Aufgabe..."></textarea>
  </div>
  <div class="row">
    <button id="btnSend">Senden</button>
  </div>
  <pre id="out" style="height:220px;overflow:auto" class="card"></pre>
</div>

<div class="card">
  <h3>Unity</h3>
  <button id="btnUnity">Unity Studio öffnen</button>
</div>

<script>
(async () => {
  try {
    const env = await window.ani.getEnv();
    document.getElementById('portN8n').value = env.n8n;
    document.getElementById('portOllama').value = env.ollama;
  } catch(e) {}
})();

document.getElementById('btnOpenN8n').onclick = async () => {
  const p = document.getElementById('portN8n').value.trim();
  const url = `http://localhost:${p}`;
  await window.ani.openN8n(url);
};

document.getElementById('btnUnity').onclick = () => window.ani.openUnity();

document.getElementById('btnSend').onclick = async () => {
  const p = document.getElementById('portN8n').value.trim();
  const base = `http://localhost:${p}`.replace(/\/$/,'');
  const url = `${base}/webhook/ai-agent`;
  const text = document.getElementById('chatText').value;
  const body = { text, chatModel: 'mistral', codeModel: 'starcoder2:7b', instrModel: 'llama2:7b-chat' };
  try {
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    const data = await res.json();
    document.getElementById('out').textContent += '\\n' + JSON.stringify(data).slice(0,4000) + '\\n';
  } catch(e) {
    document.getElementById('out').textContent += '\\nError: ' + e + '\\n';
  }
};
</script>

<div class="card">
  <h3>n8n Monitor</h3>
  <div class="row">
    <button id="btnPing">Ping /rest/health</button>
  </div>
  <pre id="mon" style="height:180px;overflow:auto" class="card"></pre>
</div>
<script>
document.getElementById('btnPing').onclick = async () => {
  const p = document.getElementById('portN8n').value.trim();
  const url = `http://localhost:${p}/rest/health`;
  try {
    const res = await fetch(url, { headers: { 'Authorization': 'Basic ' + btoa('admin:admin') } });
    const data = await res.json();
    document.getElementById('mon').textContent = JSON.stringify(data, null, 2);
  } catch(e) {
    document.getElementById('mon').textContent = 'Error: ' + e;
  }
};
</script>

<div class="card">
  <h3>Workflows importieren</h3>
  <div class="row">
    <div>
      <label>n8n Base URL</label>
      <input id="wf_n8nUrl" placeholder="http://localhost:5678" style="width:360px">
    </div>
    <div>
      <label>n8n API Key</label>
      <input id="wf_apiKey" placeholder="API-KEY" style="width:360px">
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="btnSaveSettings">Speichern</button>
      <button id="btnImportWf">Importieren</button>
    </div>
  </div>
  <div class="small">API-Key wird in <code>.config\settings.json</code> gespeichert. Importiert alle <code>.json</code> aus <code>workflows\</code>.</div>
  <pre id="wf_out" style="height:180px;overflow:auto" class="card"></pre>
</div>

<script>
(async () => {
  try {
    const s = await window.ani.getSettings();
    document.getElementById('wf_n8nUrl').value = s.n8nBaseUrl || 'http://localhost:5678';
    document.getElementById('wf_apiKey').value = s.n8nApiKey || '';
  } catch(e) {}
})();

document.getElementById('btnSaveSettings').onclick = async () => {
  const base = document.getElementById('wf_n8nUrl').value.trim();
  const key  = document.getElementById('wf_apiKey').value.trim();
  const saved = await window.ani.saveSettings({ n8nBaseUrl: base, n8nApiKey: key });
  const out = document.getElementById('wf_out');
  out.textContent += '\nGespeichert: ' + JSON.stringify(saved);
  out.scrollTop = out.scrollHeight;
};

document.getElementById('btnImportWf').onclick = async () => {
  const base = document.getElementById('wf_n8nUrl').value.trim();
  const key  = document.getElementById('wf_apiKey').value.trim();
  const out = document.getElementById('wf_out');
  out.textContent += '\nStarte Import...';
  out.scrollTop = out.scrollHeight;
  try {
    const res = await window.ani.importWorkflows({ n8nBaseUrl: base, n8nApiKey: key });
    for (const r of res) {
      out.textContent += `\n${r.ok ? '✔' : '✖'} ${r.file}: ${r.action}${r.id ? ' (id='+r.id+')' : ''}${r.message ? ' – '+r.message : ''}`;
    }
    out.textContent += '\nFertig.';
  } catch (e) {
    out.textContent += '\nFehler: ' + (e.message || e);
  }
  out.scrollTop = out.scrollHeight;
};
</script>

