<!doctype html><html><head><meta charset="utf-8"><title>ANI – Unity Studio</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:8px}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:10px 0}
  input,textarea,button{padding:8px;border:1px solid #ccc;border-radius:8px}
  button{cursor:pointer}
  label{display:block;font-size:12px;color:#666;margin-bottom:4px}
  #fs{display:flex;gap:16px}
  #fs .pane{flex:1}
  ul{list-style:none;padding:0;margin:0}
  li{padding:4px 6px;border-radius:6px}
  li:hover{background:#f2f2f2}
  .small{font-size:12px;color:#666}
</style></head><body>
<h1>Unity Studio</h1>

<div class="card">
  <div class="row">
    <div class="col">
      <label>Unity Editor (Pfad zur Unity.exe)</label>
      <input id="unityExe" placeholder="C:\\Program Files\\Unity\\Hub\\Editor\\2022.3.xxf1\\Editor\\Unity.exe">
    </div>
    <div class="col">
      <label>Unity Projektordner</label>
      <div class="row">
        <input id="projectDir" style="min-width:420px" placeholder="C:\\Pfad\\zum\\UnityProject">
        <button id="pickProj">Wählen…</button>
        <button id="openUnity">Im Unity Editor öffnen</button>
      </div>
      <div class="small">Hinweis: Unity Hub Installationsseite wird im Launcher geöffnet, falls Unity fehlt.</div>
    </div>
  </div>
</div>

<div id="fs" class="card">
  <div class="pane">
    <h3>Dateien</h3>
    <ul id="fileList"></ul>
    <div class="row">
      <button id="refresh">Aktualisieren</button>
      <button id="newScript">Neues C#-Script</button>
    </div>
  </div>
  <div class="pane">
    <h3>Editor</h3>
    <div class="row"><input id="filePath" placeholder="Pfad zur Datei" style="flex:1"></div>
    <textarea id="editor" rows="22" style="width:100%"></textarea>
    <div class="row">
      <button id="save">Speichern</button>
      <button id="runTests">Unity Tests (per dotnet)</button>
    </div>
    <pre id="log" class="card" style="height:180px;overflow:auto"></pre>
  </div>
</div>

<div class="card">
  <h3>C# Generator (über Workflow)</h3>
  <textarea id="prompt" rows="6" style="width:100%" placeholder="Beschreibe, was an C#-Code für Unity erzeugt werden soll."></textarea>
  <div class="row">
    <button id="gen">Generieren und in Editor laden</button>
  </div>
</div>

<script>
  const ui = {
    unityExe: document.getElementById('unityExe'),
    projectDir: document.getElementById('projectDir'),
    pickProj: document.getElementById('pickProj'),
    openUnity: document.getElementById('openUnity'),
    fileList: document.getElementById('fileList'),
    refresh: document.getElementById('refresh'),
    newScript: document.getElementById('newScript'),
    filePath: document.getElementById('filePath'),
    editor: document.getElementById('editor'),
    save: document.getElementById('save'),
    runTests: document.getElementById('runTests'),
    log: document.getElementById('log'),
    prompt: document.getElementById('prompt'),
    gen: document.getElementById('gen'),
  };

  async function listDir() {
    const dir = ui.projectDir.value.trim();
    if (!dir) { ui.log.textContent += "\nBitte Projektordner setzen."; return; }
    const res = await window.ani.listDir(dir);
    if (!res.ok) { ui.log.textContent += "\nFehler: " + res.error; return; }
    ui.fileList.innerHTML='';
    for (const it of res.items) {
      if (it.type === 'file' && !it.name.endsWith('.cs')) continue; // zeig primär C#-Dateien
      const li = document.createElement('li');
      li.textContent = it.name + (it.type==='dir'?' /':'');
      li.onclick = async () => {
        const p = it.path;
        if (it.type==='dir') { ui.projectDir.value = p; await listDir(); }
        else {
          const rf = await window.ani.readFile(p);
          if (rf.ok) { ui.filePath.value = p; ui.editor.value = rf.content; }
          else ui.log.textContent += "\nLesefehler: "+rf.error;
        }
      };
      ui.fileList.appendChild(li);
    }
  }

  ui.pickProj.onclick = async () => {
    const p = await window.ani.openFolderDialog();
    if (p) { ui.projectDir.value = p; await listDir(); }
  };
  ui.refresh.onclick = () => listDir();

  ui.newScript.onclick = async () => {
    const dir = ui.projectDir.value.trim();
    if (!dir) { ui.log.textContent += "\nBitte Projektordner setzen."; return; }
    const name = "NewScript_"+Math.floor(Math.random()*1e6)+".cs";
    const path = dir.replace(/\\$/,'') + (dir.endsWith('\\')?'':"\\") + name;
    const tpl = "using UnityEngine;\n\npublic class "+name.replace('.cs','')+" : MonoBehaviour {\n  void Start(){ Debug.Log(\"Hello from "+name.replace('.cs','')+"\"); }\n}\n";
    const wf = await window.ani.writeFile(path, tpl);
    if (wf.ok){ ui.filePath.value = path; ui.editor.value = tpl; ui.log.textContent += "\nScript erzeugt: "+path; await listDir(); }
    else ui.log.textContent += "\nSchreibfehler: "+wf.error;
  };

  ui.save.onclick = async () => {
    const p = ui.filePath.value.trim();
    if (!p) { ui.log.textContent += "\nKein Dateipfad gesetzt."; return; }
    const wf = await window.ani.writeFile(p, ui.editor.value);
    ui.log.textContent += wf.ok ? "\nGespeichert." : "\nFehler: "+wf.error;
  };

  ui.runTests.onclick = async () => {
    // Versuch: dotnet test im Projektordner
    const dir = ui.projectDir.value.trim();
    if (!dir) { ui.log.textContent += "\nBitte Projektordner setzen."; return; }
    const r = await window.ani.runCommand('dotnet', ['test'], dir);
    ui.log.textContent += "\n[Test Run] code="+r.code+"\n"+ (r.stdout||'') + (r.stderr||'');
  };

  ui.openUnity.onclick = async () => {
    const exe = ui.unityExe.value.trim();
    const dir = ui.projectDir.value.trim();
    if (!exe || !dir) { ui.log.textContent += "\nPfad zur Unity.exe und Projektordner erforderlich."; return; }
    const ok = await window.ani.tryOpenUnityProject(exe, dir);
    ui.log.textContent += ok.ok ? "\nUnity Editor gestartet." : "\nUnity Start fehlgeschlagen: "+ok.error;
  };

  ui.gen.onclick = async () => {
    const text = ui.prompt.value;
    try {
      const res = await fetch('http://localhost:5678/webhook/ai-agent', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode:'unity', text, csharpModel:'starcoder2:7b' })
      });
      const data = await res.json();
      const body = JSON.stringify(data);
      // naive extraction of code from response
      const m = body.match(/```(?:c#|csharp)?([\s\S]*?)```/i);
      const code = m ? m[1].trim() : body.substring(0,3000);
      ui.editor.value = code;
      ui.log.textContent += "\nGenerator OK (Code in Editor geladen)";
    } catch(e) {
      ui.log.textContent += "\nGenerator Fehler: "+e;
    }
  };

  // init
  (async ()=>{
    await listDir();
  })();
</script>
</body></html>
